REPORT DIAGNOSI FIX WHATSAPP + UNITÃ€ CREA ORDINE - 28/09/2025
================================================================

ğŸ¯ FILE ANALIZZATI:
- src/components/modals/WhatsAppOrderModal.tsx (199 righe)
- src/utils/buildWhatsAppMessage.ts (71 righe)
- src/pages/CreaOrdinePage.tsx (282 righe)
- src/hooks/useCreaOrdine.ts (82 righe)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# A) DIAGNOSI WHATSAPP - TESTO NON PRECOMPILATO SU MOBILE

ğŸ” PROBLEMI IDENTIFICATI:

**A1) ORDINE FALLBACK ERRATO:**
- Linea 30-35: Prima prova wa.me (web), poi whatsapp:// (mobile app)
- PROBLEMA: Su mobile dovrebbe provare prima whatsapp:// per app nativa
- CAUSA: Ordine invertito causa apertura web invece di app mobile

**A2) ENCODING CORRETTO MA MIGLIORABILE:**
- buildWhatsAppMessage.ts linea 49: return lines.join('\n')
- buildWhatsAppUrl.ts linea 58: encodeURIComponent(message)
- âœ… Encoding giÃ  corretto, ma manca normalizzazione CRLF

**A3) APERTURA SINCRONA CORRETTA:**
- âœ… window.open chiamato direttamente nel click handler (linea 31, 35)
- âœ… Nessun await/RPC prima dell'apertura
- âœ… Nessuna chiusura modale prima dell'open

**CAUSA ROOT:** Ordine fallback mobile-first errato

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# B) DIAGNOSI CREA ORDINE - UNITÃ€ AUTO-SWITCH

ğŸ” PROBLEMI IDENTIFICATI:

**B1) DEFAULT UNITÃ€ SBAGLIATO:**
- useCreaOrdine.ts linea 33: unit: 'bottiglie' (dovrebbe essere 'cartoni')
- PROBLEMA: Nuovi item partono con 'bottiglie' invece di 'cartoni'

**B2) RESET QUANTITÃ€ SU CAMBIO UNITÃ€:**
- useCreaOrdine.ts linea 47-48: newItems[existingIndex].quantity = 0
- PROBLEMA: Cambiare unitÃ  azzera la quantitÃ  (comportamento indesiderato)
- CAUSA: Reset automatico impedisce persistenza quantitÃ  per unitÃ 

**B3) LOGICA UI CORRETTA:**
- CreaOrdinePage.tsx linea 200: currentItem.unit === 'cartoni' default
- âœ… UI giÃ  mostra 'Cartoni' come default se currentItem non esiste
- âœ… Nessun useEffect che auto-cambia unitÃ  in base a quantitÃ 

**CAUSA ROOT:** 
1. Default 'bottiglie' invece di 'cartoni' in nuovo item
2. Reset quantitÃ  su cambio unitÃ  impedisce workflow manuale

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# C) PIANO IMPLEMENTAZIONE

**FIX A) WHATSAPP MOBILE-FIRST:**
1. Invertire ordine fallback: whatsapp:// â†’ wa.me â†’ web.whatsapp.com
2. Aggiungere normalizzazione CRLF in buildWhatsAppMessage
3. Parametri window.open ottimizzati per mobile

**FIX B) UNITÃ€ MANUALE DEFAULT CARTONI:**
1. Cambiare default da 'bottiglie' â†’ 'cartoni' in nuovo item
2. Rimuovere reset quantitÃ  su cambio unitÃ 
3. Mantenere quantitÃ  esistente quando si cambia unitÃ 

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# D) FILE DA MODIFICARE

**WHATSAPP:**
- src/components/modals/WhatsAppOrderModal.tsx (handler apertura)
- src/utils/buildWhatsAppMessage.ts (normalizzazione messaggio)

**CREA ORDINE:**
- src/hooks/useCreaOrdine.ts (default + logica cambio unitÃ )

STATO: Diagnosi completata, cause identificate, piano implementazione definito.

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# E) IMPLEMENTAZIONE COMPLETATA - 28/09/2025

âœ… **FIX A) WHATSAPP MOBILE-FIRST COMPLETATO:**

**File modificati:**
- src/utils/buildWhatsAppMessage.ts (83 righe, +12 righe)
- src/components/modals/WhatsAppOrderModal.tsx (199 righe, modifiche handler)

**Modifiche applicate:**
1. âœ… Normalizzazione messaggio: CRLFâ†’LF + trim finale (linea 50-51)
2. âœ… Nuove funzioni URL: buildWhatsAppMobileUrl, buildWhatsAppWebUrl
3. âœ… Sequenza mobile-first: whatsapp:// â†’ wa.me â†’ web.whatsapp.com
4. âœ… Apertura sincrona con parametri noopener,noreferrer
5. âœ… Log success non bloccante con setTimeout(0)

**Risultato atteso:**
- Su mobile: Apre app WhatsApp nativa con testo precompilato
- Su desktop: Fallback a web.whatsapp.com con testo precompilato
- Messaggio normalizzato senza caratteri problematici

âœ… **FIX B) UNITÃ€ MANUALE DEFAULT CARTONI COMPLETATO:**

**File modificati:**
- src/hooks/useCreaOrdine.ts (82 righe, modifiche logica)

**Modifiche applicate:**
1. âœ… Default nuovo item: 'bottiglie' â†’ 'cartoni' (linea 33)
2. âœ… Rimosso reset quantitÃ  su cambio unitÃ  (linea 47-48)
3. âœ… Persistenza quantitÃ  esistente quando si cambia unitÃ 
4. âœ… Fallback 'cartoni' per nuovi item senza unitÃ  specificata

**Risultato atteso:**
- Nuove righe partono con "Cartoni" selezionato
- Cambiare unitÃ  mantiene la quantitÃ  esistente
- Selezione unitÃ  completamente manuale (no auto-switch)

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# F) COMMIT SUGGERITI

```bash
git add src/utils/buildWhatsAppMessage.ts src/components/modals/WhatsAppOrderModal.tsx
git commit -m "fix(wa): mobile deep-link with proper encoding & sync open"

git add src/hooks/useCreaOrdine.ts
git commit -m "fix(order): unit selection manual-only (default cartoni)"
```

STATO FINALE: Entrambi i fix implementati, pronti per test su dispositivi reali.
